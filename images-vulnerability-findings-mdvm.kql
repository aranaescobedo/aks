SecurityResources
| where type =~ "microsoft.security/assessments/subassessments" and id has "c609cf0f-71ab-41e9-a3c6-9a1f7fe1b8d5" //the ID of the assessment - 
//Running container images should have vulnerability findings resolved (powered by Microsoft Defender Vulnerability Management)
| extend
    cveId = properties.additionalData.vulnerabilityDetails.cveId,
    status = properties.status.code
| where 
    status == "Unhealthy" and cveId in ("<CVE_ID>","<CVE_ID>")
| extend parse_json(properties),
    imageDigest = properties.additionalData.artifactDetails.digest,
    imageTag = strcat_array(properties.additionalData.artifactDetails.tags, "::"),
    lastModified = todatetime(properties.timeGenerated),
    registryHost = properties.additionalData.artifactDetails.registryHost,
    repoName = properties.additionalData.artifactDetails.repositoryName,
    workloads = properties.additionalData.kubernetesContext.workloads[0]
| summarize by
    ACRName = tostring(registryHost),
    RepositoryName = tostring(repoName),
    ImageTag = tostring(imageTag),
    ImageDigest = tostring(imageDigest),
    LastModified = format_datetime(lastModified, 'yyyy-MM-dd'),
    Namespace = tostring(workloads.namespace),
    PodName = tostring(workloads.ownedResources[0].name),
    CVECode = tostring(cveId)
| order by LastModified desc

//Inspiration.
//https://github.com/ep3p/Sentinel_KQL/blob/main/Queries/Defender%20for%20Cloud/Multiple-Running%20container%20image%20MDVM%20vulnerability%20assessments.kql

//Source.
//https://learn.microsoft.com/en-us/azure/defender-for-cloud/agentless-container-registry-vulnerability-assessment

//Supported tabular/top level operators
//https://learn.microsoft.com/en-us/azure/governance/resource-graph/concepts/query-language#supported-kql-language-elements
