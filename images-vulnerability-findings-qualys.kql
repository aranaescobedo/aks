SecurityResources
| where type =~ "microsoft.security/assessments/subassessments" and id has "41503391-efa5-47ee-9282-4eff6131462c" //the ID of the assessment - 
//Running container images should have vulnerability findings resolved (powered by Qualys)
|  extend
    cve = dynamic_to_json(properties.additionalData.data.Cve),
    status = properties.status.code
| where
    status == "Unhealthy" and tostring(parse_json(cve)[0].Id) in ("<CVE_ID>","<CVE_ID>")
| extend parse_json(properties),
     containers = parse_json(tostring(parse_json(properties.additionalData.data.Containers)))[0],
     cveId = parse_json(cve)[0].Id,
     imageDigest = split(properties.resourceDetails.id,"@")[1],
     imageTag = properties.additionalData.data.Tag,
     lastModified = todatetime(properties.additionalData.data.ScanTime),
     repoName = split(properties.resourceDetails.id,"@")[0]
| summarize by
     RepositoryName = tostring(repoName),
     ImageTag = tostring(imageTag),
     ImageDigest = tostring(imageDigest),
     LastModified = format_datetime(lastModified, 'yyyy-MM-dd'),
     Namespace = tostring(containers.Pod.Namespace),
     PodName = tostring(containers.Pod.Name),
     CVECode = tostring(cveId)
| order by LastModified desc

//Inspiration
//https://github.com/ep3p/Sentinel_KQL/blob/main/Queries/Defender%20for%20Cloud/Multiple-Running%20container%20image%20Qualys%20vulnerability%20assessments.kql
